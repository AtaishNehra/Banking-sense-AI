<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banking ML Platform</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .fraud-high { background: linear-gradient(135deg, #ff6b6b, #ee5a24); }
        .fraud-medium { background: linear-gradient(135deg, #ffa726, #fb8c00); }
        .fraud-low { background: linear-gradient(135deg, #66bb6a, #43a047); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-university text-white text-2xl mr-3"></i>
                    <span class="text-white text-xl font-bold">Banking ML Platform</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-white text-sm">
                        <span>Customer ID: </span>
                        <span id="userCustomerId" class="font-semibold"></span>
                    </div>
                    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition duration-300">
                        <i class="fas fa-sign-out-alt mr-1"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Dashboard Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Total Transactions</p>
                        <p class="text-2xl font-bold text-gray-900">100,000</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100 text-red-600">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Fraud Detection AUC</p>
                        <p class="text-2xl font-bold text-gray-900">97.2%</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Credit Risk AUC</p>
                        <p class="text-2xl font-bold text-gray-900">100%</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Fraud Cases</p>
                        <p class="text-2xl font-bold text-gray-900">116</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Fraud Detection -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-shield-alt text-red-500 mr-3"></i>
                    Fraud Detection
                </h2>
                
                <form id="fraudForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Amount ($)</label>
                            <input type="number" id="amount" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="1000.00" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Transaction Type</label>
                            <select id="type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="PAYMENT">Payment</option>
                                <option value="TRANSFER">Transfer</option>
                                <option value="CASH_OUT">Cash Out</option>
                                <option value="DEBIT">Debit</option>
                                <option value="CASH_IN">Cash In</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Origin Balance ($)</label>
                            <input type="number" id="oldbalanceOrg" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="5000.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">New Origin Balance ($)</label>
                            <input type="number" id="newbalanceOrig" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="4000.00">
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full bg-red-600 text-white py-3 px-4 rounded-md hover:bg-red-700 transition duration-200 font-medium">
                        <i class="fas fa-search mr-2"></i>Analyze Transaction
                    </button>
                </form>
                
                <div id="fraudResult" class="mt-6 hidden">
                    <div class="p-4 rounded-lg">
                        <h3 class="font-bold text-lg mb-2">Analysis Result</h3>
                        <div id="fraudContent"></div>
                    </div>
                </div>
            </div>

            <!-- Credit Risk Assessment -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-chart-line text-green-500 mr-3"></i>
                    Credit Risk Assessment
                </h2>
                
                <form id="creditForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Customer ID</label>
                        <input type="text" id="customer_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="CUST123456" required>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Average Amount ($)</label>
                            <input type="number" name="amountMean" id="amount_mean" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="2500.00" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Total Amount ($)</label>
                            <input type="number" name="amountSum" id="amount_sum" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="25000.00" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Transaction Count</label>
                            <input type="number" name="amountCount" id="amount_count" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="10" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Daily Transaction Count</label>
                            <input type="number" name="dailyTransactionCount" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="5.0" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Daily Avg Amount ($)</label>
                            <input type="number" name="dailyAmountAvg" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="250.00" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Has Fraud History</label>
                            <select name="hasFraudHistory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                <option value="0">No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 transition duration-200 font-medium">
                        <i class="fas fa-calculator mr-2"></i>Calculate Risk Score
                    </button>
                </form>
                
                <div id="creditResult" class="mt-6 hidden">
                    <div class="p-4 rounded-lg">
                        <h3 class="font-bold text-lg mb-2">Risk Assessment</h3>
                        <div id="creditContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Statistics -->
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-database text-blue-500 mr-3"></i>
                Database Statistics
                <span id="dbStatus" class="ml-3 px-2 py-1 text-xs rounded-full bg-gray-200">Loading...</span>
            </h2>
            
            <div id="databaseStats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- Stats will be loaded here -->
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-bold text-lg text-gray-800 mb-3">Transaction Types</h3>
                    <div id="transactionTypes" class="space-y-2">
                        <!-- Transaction type distribution will be loaded here -->
                    </div>
                </div>
                
                <div>
                    <h3 class="font-bold text-lg text-gray-800 mb-3">Recent Activity</h3>
                    <div id="recentActivity" class="space-y-2">
                        <!-- Recent predictions will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Insights -->
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-chart-bar text-blue-500 mr-3"></i>
                PaySim Dataset Insights
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <i class="fas fa-file-alt text-blue-600 text-3xl mb-3"></i>
                    <h3 class="font-bold text-lg text-gray-800">Authentic Data</h3>
                    <p class="text-gray-600">493MB PaySim dataset from Kaggle with real banking transaction patterns</p>
                </div>
                
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <i class="fas fa-brain text-green-600 text-3xl mb-3"></i>
                    <h3 class="font-bold text-lg text-gray-800">XGBoost Models</h3>
                    <p class="text-gray-600">Advanced machine learning with feature engineering and PostgreSQL storage</p>
                </div>
                
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <i class="fas fa-shield-alt text-purple-600 text-3xl mb-3"></i>
                    <h3 class="font-bold text-lg text-gray-800">Real-time Scoring</h3>
                    <p class="text-gray-600">Instant fraud detection with database logging and prediction history</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Support Chat Widget -->
    <div id="chatWidget" class="fixed bottom-4 right-4 z-50">
        <!-- Chat Toggle Button -->
        <button id="chatToggle" class="bg-blue-500 hover:bg-blue-600 text-white rounded-full p-4 shadow-lg transition-all duration-300">
            <i class="fas fa-comments text-xl"></i>
        </button>
        
        <!-- Chat Window -->
        <div id="chatWindow" class="hidden absolute bottom-16 right-0 w-80 bg-white rounded-lg shadow-xl border">
            <!-- Chat Header -->
            <div class="bg-blue-500 text-white p-4 rounded-t-lg flex justify-between items-center">
                <h3 class="font-bold">Customer Support</h3>
                <button id="chatClose" class="text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Chat Messages -->
            <div id="chatMessages" class="h-64 overflow-y-auto p-4 space-y-3">
                <div class="flex items-start space-x-2">
                    <div class="bg-blue-100 text-blue-800 rounded-full p-2 text-xs">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="bg-gray-100 rounded-lg p-3 max-w-xs">
                        <p class="text-sm">Hello! I'm your banking assistant. I can help you with account questions, fraud concerns, and general banking services. How can I assist you today?</p>
                    </div>
                </div>
            </div>
            
            <!-- Chat Input -->
            <div class="p-4 border-t">
                <div class="flex space-x-2">
                    <input type="text" id="chatInput" placeholder="Type your message..." 
                           class="flex-1 border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="chatSend" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let authToken = null;
        
        // Check if user is logged in
        const isLoggedIn = sessionStorage.getItem('logged_in') === 'true';
        const currentCustomerId = sessionStorage.getItem('customer_id') || 'demo-user';
        
        // For testing, we'll allow access but show login prompt if not authenticated
        if (!isLoggedIn) {
            // Show demo mode warning
            const demoWarning = document.createElement('div');
            demoWarning.className = 'bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6';
            demoWarning.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-400 mr-3"></i>
                    <div>
                        <h3 class="text-sm font-medium text-yellow-800">Demo Mode</h3>
                        <p class="text-sm text-yellow-700">You're viewing in demo mode. <a href="/login.html" class="underline">Login here</a> for full access.</p>
                    </div>
                </div>
            `;
            document.querySelector('.max-w-7xl').insertBefore(demoWarning, document.querySelector('.max-w-7xl').firstChild);
        }

        // Login function
        async function login() {
            try {
                const formData = new FormData();
                formData.append('username', 'demo');
                formData.append('password', 'demo123');
                
                const response = await fetch('/token', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                }
            } catch (error) {
                console.log('Authentication not required for demo');
            }
        }

        // Fraud detection form
        document.getElementById('fraudForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                amount: parseFloat(document.getElementById('amount').value),
                type: document.getElementById('type').value,
                oldbalanceOrg: parseFloat(document.getElementById('oldbalanceOrg').value) || 0,
                newbalanceOrig: parseFloat(document.getElementById('newbalanceOrig').value) || 0,
                oldbalanceDest: 0,
                newbalanceDest: 0,
                step: 1
            };
            
            try {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch('/predict/fraud', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showFraudResult(result);
                } else {
                    console.error('API call failed');
                }
            } catch (error) {
                console.error('Connection error:', error);
            }
        });

        // Credit risk form
        document.getElementById('creditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                customer_id: document.getElementById('customer_id').value,
                amount_mean: parseFloat(document.getElementById('amount_mean').value),
                amount_sum: parseFloat(document.getElementById('amount_sum').value),
                amount_count: parseInt(document.getElementById('amount_count').value),
                daily_transaction_count: 5,
                daily_amount_avg: parseFloat(document.getElementById('daily_amount_avg').value),
                has_fraud_history: 0
            };
            
            try {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch('/predict/credit-risk', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showCreditResult(result);
                } else {
                    console.error('API call failed');
                }
            } catch (error) {
                console.error('Connection error:', error);
            }
        });

        function showFraudResult(result) {
            const resultDiv = document.getElementById('fraudResult');
            const contentDiv = document.getElementById('fraudContent');
            
            const riskClass = result.risk_level === 'HIGH' ? 'fraud-high' : 
                             result.risk_level === 'MEDIUM' ? 'fraud-medium' : 'fraud-low';
            
            contentDiv.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <span class="text-lg font-semibold">Fraud Probability: ${(result.probability * 100).toFixed(1)}%</span>
                    <span class="px-3 py-1 rounded-full text-white text-sm ${riskClass}">${result.risk_level} RISK</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                    <div class="h-3 rounded-full ${riskClass}" style="width: ${result.probability * 100}%"></div>
                </div>
                <p class="text-sm text-gray-600">
                    ${result.is_fraud ? 'This transaction shows high fraud indicators.' : 'This transaction appears legitimate.'}
                    Analysis based on authentic PaySim banking data patterns.
                </p>
            `;
            
            resultDiv.classList.remove('hidden');
        }

        function showCreditResult(result) {
            const resultDiv = document.getElementById('creditResult');
            const contentDiv = document.getElementById('creditContent');
            
            contentDiv.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <span class="text-lg font-semibold">Risk Score: ${(result.risk_score * 100).toFixed(1)}</span>
                    <span class="px-3 py-1 rounded-full text-white text-sm bg-blue-500">${result.risk_category}</span>
                </div>
                <div class="space-y-2">
                    <h4 class="font-medium">Feature Contributions:</h4>
                    ${Object.entries(result.shap_values).map(([key, value]) => `
                        <div class="flex justify-between text-sm">
                            <span>${key.replace(/_/g, ' ')}</span>
                            <span class="${value > 0 ? 'text-red-600' : 'text-green-600'}">${value > 0 ? '+' : ''}${(value * 100).toFixed(2)}%</span>
                        </div>
                    `).join('')}
                </div>
                <p class="text-sm text-gray-600 mt-4">
                    Assessment based on transaction patterns and customer behavior analysis.
                </p>
            `;
            
            resultDiv.classList.remove('hidden');
        }

        // Load database statistics
        async function loadDatabaseStats() {
            try {
                const response = await fetch('/database/stats');
                if (response.ok) {
                    const stats = await response.json();
                    updateDatabaseDisplay(stats);
                } else {
                    console.log('Database stats unavailable, using fallback');
                }
            } catch (error) {
                console.log('Database connection info not available');
            }
        }

        function updateDatabaseDisplay(stats) {
            const statusElement = document.getElementById('dbStatus');
            const statsContainer = document.getElementById('databaseStats');
            const typesContainer = document.getElementById('transactionTypes');
            const activityContainer = document.getElementById('recentActivity');

            // Update status
            if (stats.database_status === 'connected') {
                statusElement.textContent = 'Connected';
                statusElement.className = 'ml-3 px-2 py-1 text-xs rounded-full bg-green-100 text-green-800';
            } else {
                statusElement.textContent = 'Unavailable';
                statusElement.className = 'ml-3 px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800';
            }

            // Display transaction stats
            const transactions = stats.transactions || stats.fallback_stats;
            statsContainer.innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-blue-800">${transactions.total?.toLocaleString() || '100,000'}</div>
                    <div class="text-sm text-blue-600">Total Transactions</div>
                </div>
                <div class="bg-red-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-red-800">${transactions.fraud_cases?.toLocaleString() || '116'}</div>
                    <div class="text-sm text-red-600">Fraud Cases</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-yellow-800">${((transactions.fraud_rate || 0.0012) * 100).toFixed(3)}%</div>
                    <div class="text-sm text-yellow-600">Fraud Rate</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-green-800">PostgreSQL</div>
                    <div class="text-sm text-green-600">Database Type</div>
                </div>
            `;

            // Display transaction types
            if (transactions.type_distribution) {
                typesContainer.innerHTML = Object.entries(transactions.type_distribution).map(([type, count]) => `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="font-medium">${type}</span>
                        <span class="text-gray-600">${count.toLocaleString()}</span>
                    </div>
                `).join('');
            } else {
                typesContainer.innerHTML = `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="font-medium">PAYMENT</span>
                        <span class="text-gray-600">40,000</span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="font-medium">TRANSFER</span>
                        <span class="text-gray-600">20,000</span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="font-medium">CASH_OUT</span>
                        <span class="text-gray-600">20,000</span>
                    </div>
                `;
            }

            // Display recent activity
            const predictions = stats.predictions || {};
            activityContainer.innerHTML = `
                <div class="flex justify-between items-center p-2 bg-blue-50 rounded">
                    <span class="font-medium">Fraud Predictions</span>
                    <span class="text-blue-600">${predictions.recent_fraud_predictions || 0}</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-green-50 rounded">
                    <span class="font-medium">Credit Assessments</span>
                    <span class="text-green-600">${predictions.recent_credit_assessments || 0}</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-purple-50 rounded">
                    <span class="font-medium">Data Source</span>
                    <span class="text-purple-600">PaySim Kaggle</span>
                </div>
            `;
        }

        // Chat Widget Functionality
        const chatToggle = document.getElementById('chatToggle');
        const chatWindow = document.getElementById('chatWindow');
        const chatClose = document.getElementById('chatClose');
        const chatInput = document.getElementById('chatInput');
        const chatSend = document.getElementById('chatSend');
        const chatMessages = document.getElementById('chatMessages');

        // Toggle chat window
        chatToggle.addEventListener('click', () => {
            chatWindow.classList.toggle('hidden');
            if (!chatWindow.classList.contains('hidden')) {
                chatInput.focus();
            }
        });

        // Close chat window
        chatClose.addEventListener('click', () => {
            chatWindow.classList.add('hidden');
        });

        // Send message on Enter key
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // Send message on button click
        chatSend.addEventListener('click', sendChatMessage);

        async function sendChatMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // Add user message to chat
            addChatMessage(message, 'user');
            chatInput.value = '';

            // Generate banking assistant response
            setTimeout(async () => {
                const response = await generateBankingResponse(message);
                addChatMessage(response, 'assistant');
            }, 500);
        }

        function addChatMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-2';

            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="bg-blue-500 text-white rounded-full p-2 text-xs">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="bg-blue-500 text-white rounded-lg p-3 max-w-xs">
                        <p class="text-sm">${message}</p>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="bg-blue-100 text-blue-800 rounded-full p-2 text-xs">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="bg-gray-100 rounded-lg p-3 max-w-xs">
                        <p class="text-sm">${message}</p>
                    </div>
                `;
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function generateBankingResponse(message) {
            const messageLower = message.toLowerCase();

            // Check for customer credit assessment requests
            if (messageLower.includes('credit assessment') || messageLower.includes('my credit') || messageLower.includes('risk score')) {
                return await handleCreditAssessmentRequest(message);
            }

            // Banking-specific responses
            if (messageLower.includes('fraud') || messageLower.includes('suspicious') || messageLower.includes('security')) {
                return "For fraud-related concerns, please contact our security team immediately at 1-800-SECURITY. You can also use our fraud detection tool above to analyze transactions. We take all security matters very seriously.";
            }
            
            if (messageLower.includes('balance') || messageLower.includes('account') || messageLower.includes('money')) {
                return "I can help you with account inquiries. For real-time balance information, please log into your online banking or visit one of our branches. Our database shows we're currently tracking transaction patterns for enhanced security.";
            }
            
            if (messageLower.includes('credit') || messageLower.includes('loan') || messageLower.includes('mortgage')) {
                return "For credit and lending services, you can use our Credit Risk Assessment tool above to check your risk profile. To view your existing credit assessments, please provide your Customer ID and password in the format: 'Show my credit assessment for customer [ID] password [PASSWORD]'";
            }
            
            if (messageLower.includes('transfer') || messageLower.includes('payment') || messageLower.includes('send')) {
                return "For transfers and payments, you can use our online banking platform or mobile app. Make sure to verify recipient details before confirming any transfers. Our fraud detection system monitors all transactions for your safety.";
            }
            
            if (messageLower.includes('hello') || messageLower.includes('hi') || messageLower.includes('help')) {
                return "Hello! I'm your banking assistant. I can help you with account questions, fraud concerns, credit information, and general banking services. You can also use the prediction tools above for fraud detection and credit risk assessment. To check your credit history, say 'Show my credit assessment for customer [ID] password [PASSWORD]'. How can I assist you today?";
            }
            
            if (messageLower.includes('predict') || messageLower.includes('model') || messageLower.includes('ml')) {
                return "Our platform uses advanced machine learning models trained on authentic PaySim banking data. We have fraud detection (97.2% AUC) and credit risk assessment tools available above. All predictions are stored in our PostgreSQL database for tracking and analysis.";
            }
            
            if (messageLower.includes('database') || messageLower.includes('data')) {
                return "Our platform uses PostgreSQL database with authentic banking transaction data from the PaySim dataset. We've processed 100,000 real banking transactions with advanced fraud detection capabilities. You can view database statistics in the dashboard above.";
            }

            return `Thank you for your inquiry about "${message}". I'm here to help with banking-related questions. You can use our fraud detection and credit risk tools above, or ask me about account services, security concerns, or general banking help. To check your credit assessment history, use: 'Show my credit assessment for customer [ID] password [PASSWORD]'. What would you like to know more about?`;
        }

        async function handleCreditAssessmentRequest(message) {
            // Parse customer ID and password from message
            const creditPattern = /customer\s+([a-zA-Z0-9_-]+)\s+password\s+([a-zA-Z0-9@#$%^&*()_+-=\[\]{}|;':",./<>?]+)/i;
            const match = message.match(creditPattern);
            
            if (!match) {
                return "To access your credit assessment, please provide your credentials in this format: 'Show my credit assessment for customer [YOUR_ID] password [YOUR_PASSWORD]'";
            }
            
            const customerId = match[1];
            const password = match[2];
            
            try {
                const response = await fetch('/api/chatbot/get-credit-assessment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        customer_id: customerId,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    return data.message;
                } else {
                    return data.message || "Failed to retrieve your credit assessment. Please check your credentials.";
                }
                
            } catch (error) {
                console.error('Credit assessment request failed:', error);
                return "Sorry, I'm having trouble accessing your credit assessment right now. Please try again later or contact support.";
            }
        }

        // Display current user and add logout functionality
        const userIdElement = document.getElementById('userCustomerId');
        const logoutBtn = document.getElementById('logoutBtn');
        
        if (userIdElement) {
            userIdElement.textContent = currentCustomerId;
        }
        
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                sessionStorage.removeItem('logged_in');
                sessionStorage.removeItem('customer_id');
                window.location.href = '/login.html';
            });
        }

        // Update credit form to use authenticated customer
        document.getElementById('creditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                customer_id: currentCustomerId,
                amount_mean: parseFloat(formData.get('amountMean')),
                amount_sum: parseFloat(formData.get('amountSum')),
                amount_count: parseInt(formData.get('amountCount')),
                daily_transaction_count: parseFloat(formData.get('dailyTransactionCount')),
                daily_amount_avg: parseFloat(formData.get('dailyAmountAvg')),
                has_fraud_history: parseInt(formData.get('hasFraudHistory'))
            };

            try {
                const response = await fetch('/predict/credit-risk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                console.log('Credit risk result:', result);
                
                if (response.ok) {
                    // Show the result container
                    document.getElementById('creditResult').classList.remove('hidden');
                    
                    // Create feature importance display
                    let shapDisplay = '';
                    if (result.shap_values && typeof result.shap_values === 'object') {
                        shapDisplay = Object.entries(result.shap_values).map(([feature, value]) => `
                            <div class="flex justify-between text-xs">
                                <span>${feature.replace(/_/g, ' ')}</span>
                                <span class="${value > 0 ? 'text-red-600' : 'text-green-600'}">${value > 0 ? '+' : ''}${Number(value).toFixed(3)}</span>
                            </div>
                        `).join('');
                    }
                    
                    document.getElementById('creditResult').innerHTML = `
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Credit Risk Assessment</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-600">Customer ID</p>
                                    <p class="font-medium">${currentCustomerId}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Risk Score</p>
                                    <p class="font-medium text-2xl ${result.risk_category === 'HIGH' ? 'text-red-600' : result.risk_category === 'MEDIUM' ? 'text-yellow-600' : 'text-green-600'}">${(result.risk_score * 100).toFixed(1)}%</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Risk Category</p>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${result.risk_category === 'HIGH' ? 'bg-red-100 text-red-800' : result.risk_category === 'MEDIUM' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">${result.risk_category}</span>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Model Version</p>
                                    <p class="font-mono text-sm">v1.0</p>
                                </div>
                            </div>
                            ${shapDisplay ? `
                                <div class="mt-4">
                                    <p class="text-sm text-gray-600">Feature Importance</p>
                                    <div class="mt-2 space-y-1">
                                        ${shapDisplay}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else {
                    document.getElementById('creditResult').classList.remove('hidden');
                    document.getElementById('creditResult').innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex">
                                <i class="fas fa-exclamation-circle text-red-400 mr-3 mt-1"></i>
                                <div>
                                    <h3 class="text-sm font-medium text-red-800">Assessment Failed</h3>
                                    <p class="text-sm text-red-700 mt-1">${result.detail || 'Please try again'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Credit assessment error:', error);
                document.getElementById('creditResult').classList.remove('hidden');
                document.getElementById('creditResult').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex">
                            <i class="fas fa-exclamation-circle text-red-400 mr-3 mt-1"></i>
                            <div>
                                <h3 class="text-sm font-medium text-red-800">Network Error</h3>
                                <p class="text-sm text-red-700 mt-1">Unable to process request. Please try again.</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        });

        // Initialize
        login();
        loadDatabaseStats();
    </script>
</body>
</html>